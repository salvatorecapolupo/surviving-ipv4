<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calcolatore IP e Subnet - Piano di Indirizzamento</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; line-height: 1.5; }
    fieldset { margin-bottom: 1.5rem; padding: 1rem; }
    label { display: block; margin-bottom: .5rem; }
    input[type="number"], input[type="text"] { width: 100%; padding: .5rem; margin-bottom: 1rem; }
    button { padding: .5rem 1rem; margin-right: .5rem; }
    .output { background: #f9f9f9; padding: .5rem; border: 1px solid #ddd; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>Calcolatore IP e Subnet - Piano di Indirizzamento</h1>

  <fieldset id="fase-base">
    <legend>Fase Base: Classe IP e bit per sottoreti</legend>
    <form onsubmit="return false;">
      <label for="ip-base">Indirizzo IP (X.Y.Z.K):</label>
      <input type="text" id="ip-base" placeholder="es. 192.168.0.1">
      <label for="num-subnet-base">Numero di sottoreti (P):</label>
      <input type="number" id="num-subnet-base" min="1" value="5">
      <button type="button" onclick="calcolaBase()">Calcola</button>
    </form>
    <div id="risultato-base" class="output"></div>
  </fieldset>

  <fieldset id="fase-intermedia">
    <legend>Fase Intermedia: Indirizzo di rete</legend>
    <form onsubmit="return false;">
      <label for="ip-inter">Indirizzo IP (X.Y.Z.K):</label>
      <input type="text" id="ip-inter" placeholder="es. 192.168.0.130">
      <label for="mask-inter">Nuova maschera (/n o dotted):</label>
      <input type="text" id="mask-inter" placeholder="es. /26 o 255.255.255.192">
      <button type="button" onclick="calcolaRete()">Calcola</button>
    </form>
    <div id="risultato-inter" class="output"></div>
  </fieldset>

  <fieldset id="fase-avanzata">
    <legend>Fase Avanzata: Broadcast, range host</legend>
    <form onsubmit="return false;">
      <label for="ip-adv">Indirizzo di rete (X.Y.Z.0):</label>
      <input type="text" id="ip-adv" placeholder="es. 192.168.0.128">
      <label for="mask-adv">Maschera (/n o dotted):</label>
      <input type="text" id="mask-adv" placeholder="es. /26 o 255.255.255.192">
      <button type="button" onclick="calcolaAvanzate()">Calcola</button>
    </form>
    <div id="risultato-adv" class="output"></div>
  </fieldset>

  <script>
    // Funzione di utilitÃ  per validare e splittare IP
    function parseIP(ip) {
      const parts = ip.trim().split('.').map(Number);
      if (parts.length !== 4 || parts.some(o=>isNaN(o) || o<0||o>255)) return null;
      return parts;
    }
    // Converti /n in mask array e dotted
    function parseMask(maskStr) {
      let bits;
      if (maskStr.startsWith('/')) bits = parseInt(maskStr.slice(1),10);
      else {
        const m = parseIP(maskStr);
        if (!m) return null;
        bits = m.reduce((acc,oct,i)=>acc + ((oct<<i)&0xFF?8:0),0); // not used
        // fallback parse dotted to bits
        bits = m.map(o=>o.toString(2)).join('').split('1').length-1;
      }
      if (bits<0||bits>32) return null;
      const mask=[];
      for(let i=0;i<4;i++) {
        const take = Math.min(8, bits - i*8);
        mask[i] = take>0 ? (~(0xFF>>take) & 0xFF) : 0;
      }
      return {bits, mask};
    }
    // Converte array 4 a uint32
    function ipToInt(o) { return ((o[0]<<24)>>>0) + (o[1]<<16) + (o[2]<<8) + o[3]; }
    function intToIp(i){ return [(i>>>24)&255, (i>>>16)&255, (i>>>8)&255, i&255].join('.'); }

    function calcolaBase(){
      const ip = parseIP(document.getElementById('ip-base').value);
      const P = parseInt(document.getElementById('num-subnet-base').value,10);
      if(!ip||P<1) return mostra('risultato-base','Input non valido');
      const first=ip[0];
      let defBits;
      if(first<128) defBits=8;
      else if(first<192) defBits=16;
      else defBits=24;
      const subBits = Math.ceil(Math.log2(P));
      const newBits = defBits + subBits;
      mostra('risultato-base',
        `Classe: ${first<128?'A':first<192?'B':'C'}\n`+
        `Maschera default: /${defBits}\n`+
        `Bit per sottoreti: ${subBits}\n`+
        `Nuova maschera: /${newBits}`
      );
    }

    function calcolaRete(){
      const ip = parseIP(document.getElementById('ip-inter').value);
      const m = parseMask(document.getElementById('mask-inter').value);
      if(!ip||!m) return mostra('risultato-inter','Input non valido');
      const ipInt = ipToInt(ip);
      const maskInt = ipToInt(m.mask);
      const netInt = ipInt & maskInt;
      mostra('risultato-inter',
        `Indirizzo di rete: ${intToIp(netInt)}\n`+
        `Maschera: /${m.bits} (${m.mask.join('.')})`
      );
    }

    function calcolaAvanzate(){
      const net = parseIP(document.getElementById('ip-adv').value);
      const m = parseMask(document.getElementById('mask-adv').value);
      if(!net||!m) return mostra('risultato-adv','Input non valido');
      const netInt = ipToInt(net);
      const maskInt = ipToInt(m.mask);
      const broadcast = netInt | (~maskInt>>>0);
      const firstHost = netInt+1;
      const lastHost = broadcast-1;
      const total = (broadcast - netInt -1);
      mostra('risultato-adv',
        `Broadcast: ${intToIp(broadcast)}\n`+
        `Primo host: ${intToIp(firstHost)}\n`+
        `Ultimo host: ${intToIp(lastHost)}\n`+
        `Host utili: ${total}`
      );
    }

    function mostra(id, text){ document.getElementById(id).textContent = text; }
  </script>
</body>
</html>
